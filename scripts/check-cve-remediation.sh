#!/bin/bash
#
# CVE Remediation Status Checker
# Monitors Alpine package releases and base image updates for CVE fixes
#
# Usage: ./scripts/check-cve-remediation.sh
# Run weekly to check if libxml2 CVEs have been fixed upstream
#

set -euo pipefail

echo "ðŸ” Checking CVE Remediation Status..."
echo "========================================"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check current Alpine version in PHP base image
echo "ðŸ“¦ Current Base Image:"
grep "PHP_BASE_IMAGE:-php:" docker-compose.yml | sed 's/.*:-/  /'
echo ""

# Check for libxml2 CVEs in .trivyignore
echo "ðŸ”´ Suppressed CVEs:"
SUPPRESSED_CVES=$(grep -E "^CVE-" .trivyignore | wc -l)
echo "  Total: $SUPPRESSED_CVES CVEs"
grep -E "^CVE-" .trivyignore | sed 's/^/  - /'
echo ""

# Check latest Alpine libxml2 package
echo "ðŸŒ Checking Alpine Package Tracker..."
echo "  URL: https://pkgs.alpinelinux.org/package/edge/main/x86_64/libxml2"
echo ""

# Try to fetch latest version (requires curl and jq)
if command -v curl &> /dev/null; then
    echo "ðŸ“¡ Fetching latest Alpine libxml2 version..."
    ALPINE_API="https://pkgs.alpinelinux.org/package/edge/main/x86_64/libxml2"
    echo "  (Visit the URL above manually to check current version)"
    echo ""
fi

# Check if there are updates to php:8.2-fpm-alpine
echo "ðŸ³ Checking Docker Hub for base image updates..."
if command -v docker &> /dev/null; then
    echo "  Current local image:"
    docker images php:8.2-fpm-alpine --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" 2>/dev/null || echo "  Image not found locally"
    echo ""
    echo "  Pulling latest version to compare..."
    docker pull php:8.2-fpm-alpine --quiet 2>/dev/null || true
fi

# Test if CVEs are still present
echo "ðŸ”¬ Testing for CVEs in current image..."
if command -v trivy &> /dev/null; then
    echo "  Running Trivy scan..."
    # Scan for the specific CVEs
    FOUND_CVES=$(docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy image php:8.2-fpm-alpine --quiet --format json \
        | jq -r '.Results[].Vulnerabilities[]?.VulnerabilityID' 2>/dev/null \
        | grep -E "CVE-2025-(49794|49796|49795|6021)" | wc -l || echo "0")
    
    if [ "$FOUND_CVES" -gt 0 ]; then
        echo -e "  ${RED}âœ— CVEs still present ($FOUND_CVES found)${NC}"
    else
        echo -e "  ${GREEN}âœ“ CVEs appear to be fixed!${NC}"
        echo -e "  ${YELLOW}âš ï¸  ACTION REQUIRED: Update .trivyignore and rebuild images${NC}"
    fi
else
    echo "  Trivy not installed. Install: https://aquasecurity.github.io/trivy/latest/getting-started/installation/"
fi

echo ""
echo "========================================"
echo "ðŸ“… Last checked: $(date)"
echo "ðŸ”— Action items:"
echo "  1. Visit Alpine package tracker (link above)"
echo "  2. Check if libxml2 >= 2.13.9-r0 is available"
echo "  3. If available, remove CVEs from .trivyignore"
echo "  4. Run CI/CD pipeline to verify"
echo "  5. Close GitHub tracking issue"
echo ""
echo "â° Next check: $(date -d "+7 days" 2>/dev/null || date -v+7d 2>/dev/null || echo "In 7 days")"
