name: CVE Remediation Monitor

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write # Permission to create/update issues

jobs:
  monitor-cve-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v0.58.1/trivy_0.58.1_Linux-64bit.tar.gz | tar -xz -C /usr/local/bin trivy
          trivy --version

      - name: Check for suppressed CVEs
        id: check_cves
        run: |
          echo "Checking .trivyignore for suppressed CVEs..."
          SUPPRESSED_COUNT=$(grep -cE "^CVE-" .trivyignore || echo "0")
          echo "suppressed_count=$SUPPRESSED_COUNT" >> $GITHUB_OUTPUT
          
          # List suppressed CVEs
          SUPPRESSED_LIST=$(grep -E "^CVE-" .trivyignore | tr '\n' ',' || echo "none")
          echo "suppressed_list=$SUPPRESSED_LIST" >> $GITHUB_OUTPUT
          
          echo "Found $SUPPRESSED_COUNT suppressed CVEs"

      - name: Scan base image for CVEs
        id: scan_image
        run: |
          echo "Scanning php:8.2-fpm-alpine for libxml2 CVEs..."
          
          # Scan the base image
          trivy image --quiet --format json --severity HIGH,CRITICAL \
            php:8.2-fpm-alpine > trivy-results.json || true
          
          # Check if suppressed CVEs are still present
          STILL_PRESENT=0
          for cve in CVE-2025-49794 CVE-2025-49796 CVE-2025-49795 CVE-2025-6021; do
            if grep -q "$cve" trivy-results.json; then
              STILL_PRESENT=$((STILL_PRESENT + 1))
              echo "  âŒ $cve still present"
            else
              echo "  âœ… $cve appears fixed"
            fi
          done
          
          echo "still_present=$STILL_PRESENT" >> $GITHUB_OUTPUT
          
          # Get current Alpine version from image
          ALPINE_VERSION=$(docker run --rm php:8.2-fpm-alpine cat /etc/alpine-release || echo "unknown")
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
          echo "Current Alpine version: $ALPINE_VERSION"

      - name: Create or update tracking issue
        if: steps.scan_image.outputs.still_present != '0'
        uses: actions/github-script@v7
        env:
          SUPPRESSED_COUNT: ${{ steps.check_cves.outputs.suppressed_count }}
          STILL_PRESENT: ${{ steps.scan_image.outputs.still_present }}
          ALPINE_VERSION: ${{ steps.scan_image.outputs.alpine_version }}
        with:
          script: |
            const issueTitle = '[CVE] Weekly check: libxml2 vulnerabilities still present';
            const issueBody = `
            ## ðŸ” Automated CVE Monitoring Report
            
            **Date:** ${new Date().toISOString().split('T')[0]}
            **Status:** âš ï¸ CVEs still present in base image
            
            ### ðŸ“Š Summary
            - **Suppressed CVEs in .trivyignore:** ${process.env.SUPPRESSED_COUNT}
            - **CVEs still detected in scan:** ${process.env.STILL_PRESENT}
            - **Current Alpine version:** ${process.env.ALPINE_VERSION}
            - **Base image:** php:8.2-fpm-alpine
            
            ### ðŸ”´ Affected CVEs
            - CVE-2025-49794 (HIGH): Heap Use-After-Free
            - CVE-2025-49796 (MEDIUM): Type confusion DoS
            - CVE-2025-49795 (MEDIUM): Null pointer dereference DoS
            - CVE-2025-6021 (HIGH): Integer overflow â†’ stack buffer overflow
            
            ### ðŸŽ¯ Next Steps
            1. Check Alpine package tracker: https://pkgs.alpinelinux.org/package/edge/main/x86_64/libxml2
            2. Wait for libxml2 2.13.9-r0 release in Alpine stable
            3. Update base image when available
            4. Remove suppressions from .trivyignore
            
            ### ðŸ“… Timeline
            - **Next check:** ${new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0]}
            
            ---
            *This issue is automatically updated weekly. Close this issue manually once CVEs are remediated.*
            `;
            
            // Search for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('[CVE]') && issue.title.includes('libxml2')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['security', 'dependencies', 'cve-tracking']
              });
              console.log(`Created issue #${newIssue.data.number}`);
            }

      - name: Comment on success
        if: steps.scan_image.outputs.still_present == '0'
        uses: actions/github-script@v7
        with:
          script: |
            // Search for existing CVE tracking issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('[CVE]') && issue.title.includes('libxml2')
            );
            
            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## âœ… CVEs Appear to be Fixed!
                
                **Date:** ${new Date().toISOString().split('T')[0]}
                
                The automated scan no longer detects the suppressed libxml2 CVEs in \`php:8.2-fpm-alpine\`.
                
                ### ðŸŽ¯ Action Required:
                1. Manually verify the fix
                2. Remove CVEs from \`.trivyignore\`
                3. Run full CI/CD pipeline
                4. Close this issue
                
                See workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
                `
              });
              console.log(`Posted success comment on issue #${existingIssue.number}`);
            }

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: cve-monitoring-results
          path: trivy-results.json
          retention-days: 30
